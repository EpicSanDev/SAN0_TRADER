<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Bot Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        #chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            transition: height 0.3s ease;
        }

        .dark-mode #chat-container {
            background: #2d2d2d;
            color: white;
        }

        #chat-header {
            padding: 10px 15px;
            background: #007bff;
            color: white;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chat-message {
            padding: 10px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .chat-message.user {
            background: #e9ecef;
            align-self: flex-end;
        }

        .dark-mode .chat-message.user {
            background: #404040;
        }

        .chat-message.bot {
            background: #007bff15;
            align-self: flex-start;
        }

        .dark-mode .chat-message.bot {
            background: #1a1a1a;
        }

        #chat-input-container {
            padding: 15px;
            border-top: 1px solid #dee2e6;
            display: flex;
            gap: 10px;
        }

        .dark-mode #chat-input-container {
            border-top-color: #404040;
        }

        #chat-input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            outline: none;
        }

        .dark-mode #chat-input {
            background: #404040;
            border-color: #666;
            color: white;
        }

        #send-button {
            padding: 8px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #send-button:hover {
            background: #0056b3;
        }

        .chat-message small {
            color: #6c757d;
            font-size: 0.75em;
        }

        .dark-mode .chat-message small {
            color: #adb5bd;
        }

        .chat-message strong {
            color: #495057;
        }

        .dark-mode .chat-message strong {
            color: #e9ecef;
        }

        /* Previous styles remain unchanged */
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
    </button>

    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center my-4">
            <h1>Trading Bot Dashboard</h1>
            <a href="/settings" class="btn btn-primary">
                <i class="fas fa-cog"></i> Paramètres
            </a>
        </div>
        
        <!-- Spreads et Conditions de Marché -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Spreads en Temps Réel</span>
                        <span class="status-indicator status-active" title="Mise à jour en temps réel"></span>
                    </div>
                    <div class="card-body">
                        <div id="spreads-table" class="loading">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Symbole</th>
                                        <th>Spread Actuel</th>
                                        <th>Spread Max</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="spreads-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Conditions de Marché</span>
                        <span class="status-indicator status-active" title="Mise à jour en temps réel"></span>
                    </div>
                    <div class="card-body">
                        <div id="market-conditions" class="loading">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Symbole</th>
                                        <th>Volatilité</th>
                                        <th>Tendance</th>
                                        <th>Volume</th>
                                    </tr>
                                </thead>
                                <tbody id="market-conditions-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Compte et Statistiques -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Informations du compte
                    </div>
                    <div class="card-body loading" id="account-info">
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Statistiques de trading
                    </div>
                    <div class="card-body loading" id="trading-stats">
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Charts -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Performance Journalière
                    </div>
                    <div class="card-body loading">
                        <div id="daily-performance-chart"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Distribution des Trades
                    </div>
                    <div class="card-body loading">
                        <div id="trade-distribution-chart"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alertes et Notifications -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Alertes et Notifications</span>
                        <span class="badge bg-danger" id="alerts-count">0</span>
                    </div>
                    <div class="card-body">
                        <div id="alerts-container" class="loading">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Graphique -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Graphique</span>
                        <select id="symbol-select" class="form-select" style="width: auto;">
                            <option value="EURUSD">EURUSD</option>
                            <option value="GBPUSD">GBPUSD</option>
                            <option value="USDJPY">USDJPY</option>
                        </select>
                    </div>
                    <div class="card-body">
                        <div id="price-chart" class="loading"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Positions ouvertes -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        Positions ouvertes
                    </div>
                    <div class="card-body">
                        <div id="positions-table" class="table-responsive loading">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Ticket</th>
                                        <th>Symbole</th>
                                        <th>Type</th>
                                        <th>Volume</th>
                                        <th>Prix d'ouverture</th>
                                        <th>Prix actuel</th>
                                        <th>SL</th>
                                        <th>TP</th>
                                        <th>Profit</th>
                                        <th>Temps</th>
                                    </tr>
                                </thead>
                                <tbody id="positions-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contrôles manuels -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        Placer un ordre
                    </div>
                    <div class="card-body">
                        <form id="order-form" class="row g-3">
                            <div class="col-md-3">
                                <label for="order-symbol" class="form-label">Symbole</label>
                                <select class="form-select" id="order-symbol" required>
                                    <option value="EURUSD">EURUSD</option>
                                    <option value="GBPUSD">GBPUSD</option>
                                    <option value="USDJPY">USDJPY</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="order-type" class="form-label">Type</label>
                                <select class="form-select" id="order-type" required>
                                    <option value="BUY">ACHAT</option>
                                    <option value="SELL">VENTE</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="order-volume" class="form-label">Volume</label>
                                <input type="number" class="form-control" id="order-volume" step="0.01" min="0.01" value="0.01" required>
                            </div>
                            <div class="col-md-2">
                                <label for="order-sl" class="form-label">Stop Loss</label>
                                <input type="number" class="form-control" id="order-sl" step="0.0001">
                            </div>
                            <div class="col-md-2">
                                <label for="order-tp" class="form-label">Take Profit</label>
                                <input type="number" class="form-control" id="order-tp" step="0.0001">
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <span class="submit-text">Placer l'ordre</span>
                                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Historique des trades -->
        <div class="row mt-4 mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        Historique des trades
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Symbole</th>
                                        <th>Type</th>
                                        <th>Volume</th>
                                        <th>Prix entrée</th>
                                        <th>Prix sortie</th>
                                        <th>Profit</th>
                                    </tr>
                                </thead>
                                <tbody id="history-body" class="loading">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Interface -->
    <div id="chat-container">
        <div id="chat-header">
            <span>Trading Assistant</span>
            <button class="btn btn-sm btn-outline-light" onclick="toggleChat()">
                <i class="fas fa-minus"></i>
            </button>
        </div>
        <div id="chat-messages"></div>
        <div id="chat-input-container">
            <input type="text" id="chat-input" placeholder="Ask about market analysis...">
            <button id="send-button">Send</button>
        </div>
    </div>

    <script>
        // Global variables
        let chatMinimized = false;

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // WebSocket Connection
            const socket = io();

            socket.on('connect', () => {
                console.log('Connected to server');
                addSystemMessage('Connected to trading assistant');
            });

            socket.on('chat_message', (message) => {
                addChatMessage(message);
            });

            socket.on('chat_history', (messages) => {
                const chatMessages = document.getElementById('chat-messages');
                chatMessages.innerHTML = '';
                messages.forEach(message => addChatMessage(message));
            });

            socket.on('analysis_response', (response) => {
                if (response.error) {
                    addSystemMessage(`Error: ${response.error}`);
                    return;
                }
                
                const analysis = response.analysis;
                let message = `Analysis for ${response.symbol}:\n`;
                message += `Decision: ${analysis.decision}\n`;
                message += `Confidence: ${analysis.confidence}%\n`;
                message += `Market Context:\n`;
                message += `- Trend Strength: ${analysis.market_context.trend_strength}\n`;
                message += `- Volatility: ${analysis.market_context.volatility_rating}\n`;
                message += `- Conditions: ${analysis.market_context.trading_conditions}`;
                
                addSystemMessage(message);
            });

            // Chat input handling
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');

            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            sendButton.addEventListener('click', sendMessage);

            function sendMessage() {
                const message = chatInput.value.trim();
                
                if (!message) return;
                
                // Check if message is requesting market analysis
                const analysisMatch = message.match(/analyze\s+([A-Z]+)/i);
                if (analysisMatch) {
                    const symbol = analysisMatch[1].toUpperCase();
                    socket.emit('request_analysis', { symbol });
                    addChatMessage({
                        user: 'You',
                        message: message,
                        timestamp: new Date().toLocaleTimeString()
                    });
                } else {
                    socket.emit('chat_message', {
                        user: 'You',
                        message: message
                    });
                }
                
                chatInput.value = '';
            }

            function addChatMessage(message) {
                const chatMessages = document.getElementById('chat-messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${message.user === 'System' ? 'bot' : 'user'}`;
                messageDiv.innerHTML = `
                    <small>${message.timestamp}</small><br>
                    <strong>${message.user}:</strong> ${message.message}
                `;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function addSystemMessage(text) {
                addChatMessage({
                    user: 'System',
                    message: text,
                    timestamp: new Date().toLocaleTimeString()
                });
            }

            // Initialize theme
            initTheme();

            // Initial updates
            updateAccountInfo();
            updatePositions();
            updateChart();
            updateStats();
            updateHistory();
            updateSpreads();
            updateMarketConditions();
            updatePerformanceCharts();
            updateAlerts();

            // Set up periodic updates
            setInterval(updateAccountInfo, 5000);       // Every 5 seconds
            setInterval(updatePositions, 5000);         // Every 5 seconds
            setInterval(updateChart, 30000);            // Every 30 seconds
            setInterval(updateStats, 60000);            // Every minute
            setInterval(updateHistory, 60000);          // Every minute
            setInterval(updateSpreads, 5000);           // Every 5 seconds
            setInterval(updateMarketConditions, 5000);  // Every 5 seconds
            setInterval(updatePerformanceCharts, 60000);// Every minute
            setInterval(updateAlerts, 10000);           // Every 10 seconds

            // Chart symbol change handler
            $('#symbol-select').change(function() {
                updateChart();
            });

            // Handle window resize for charts
            window.addEventListener('resize', function() {
                const charts = ['daily-performance-chart', 'trade-distribution-chart', 'price-chart'];
                charts.forEach(chartId => {
                    const chart = document.getElementById(chartId);
                    if (chart && chart.data) {
                        Plotly.Plots.resize(chart);
                    }
                });
            });

            // Form submission handling
            $('#order-form').submit(async function(e) {
                e.preventDefault();
                const submitBtn = $(this).find('button[type="submit"]');
                const submitText = submitBtn.find('.submit-text');
                const spinner = submitBtn.find('.spinner-border');
                
                try {
                    submitBtn.prop('disabled', true);
                    submitText.addClass('d-none');
                    spinner.removeClass('d-none');

                    const orderData = {
                        symbol: $('#order-symbol').val(),
                        type: $('#order-type').val(),
                        volume: parseFloat($('#order-volume').val()),
                        sl: parseFloat($('#order-sl').val()) || null,
                        tp: parseFloat($('#order-tp').val()) || null
                    };

                    const response = await apiRequest('/api/order', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(orderData)
                    });

                    if (response.success) {
                        alert('Ordre placé avec succès !');
                        updatePositions();
                        this.reset();
                    } else {
                        alert('Erreur : ' + response.error);
                    }
                } catch (error) {
                    alert('Erreur lors du placement de l\'ordre');
                } finally {
                    submitBtn.prop('disabled', false);
                    submitText.removeClass('d-none');
                    spinner.addClass('d-none');
                }
            });
        });

        // Global functions
        function toggleChat() {
            const chatContainer = document.getElementById('chat-container');
            const toggleButton = document.querySelector('#chat-header button i');
            chatMinimized = !chatMinimized;
            
            if (chatMinimized) {
                chatContainer.style.height = '50px';
                toggleButton.classList.remove('fa-minus');
                toggleButton.classList.add('fa-expand');
            } else {
                chatContainer.style.height = '500px';
                toggleButton.classList.remove('fa-expand');
                toggleButton.classList.add('fa-minus');
                
                // Scroll to bottom when expanding
                const chatMessages = document.getElementById('chat-messages');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode);
            updateChartTheme();
        }

        function initTheme() {
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                updateChartTheme();
            }
        }

        function updateChartTheme() {
            const isDarkMode = document.body.classList.contains('dark-mode');
            const chartConfig = {
                paper_bgcolor: isDarkMode ? '#2d2d2d' : '#fff',
                plot_bgcolor: isDarkMode ? '#2d2d2d' : '#fff',
                font: {
                    color: isDarkMode ? '#fff' : '#000'
                },
                xaxis: {
                    gridcolor: isDarkMode ? '#404040' : '#e6e6e6'
                },
                yaxis: {
                    gridcolor: isDarkMode ? '#404040' : '#e6e6e6'
                }
            };

            const charts = ['daily-performance-chart', 'trade-distribution-chart', 'price-chart'];
            charts.forEach(chartId => {
                const chart = document.getElementById(chartId);
                if (chart && chart.data) {
                    Plotly.relayout(chartId, chartConfig);
                }
            });
        }

        // Error handling function
        function handleError(element, error) {
            element.classList.remove('loading');
            element.innerHTML = `
                <div class="error-message">
                    <strong>Erreur:</strong> ${error}
                </div>
            `;
        }

        // Loading state management
        function setLoading(element, isLoading) {
            if (isLoading) {
                element.classList.add('loading');
            } else {
                element.classList.remove('loading');
            }
        }

        // API request wrapper with error handling
        async function apiRequest(url, options = {}) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`API Error (${url}):`, error);
                throw error;
            }
        }

        // Update functions
        async function updateSpreads() {
            const element = document.getElementById('spreads-table');
            try {
                setLoading(element, true);
                const data = await apiRequest('/api/spreads');
                let html = '';
                data.forEach(item => {
                    const statusClass = item.current_spread <= item.max_spread ? 'text-success' : 'text-danger';
                    html += `
                        <tr>
                            <td>${item.symbol}</td>
                            <td>${item.current_spread.toFixed(1)}</td>
                            <td>${item.max_spread.toFixed(1)}</td>
                            <td>
                                <span class="badge ${statusClass}">
                                    ${item.current_spread <= item.max_spread ? 'OK' : 'Élevé'}
                                </span>
                            </td>
                        </tr>
                    `;
                });
                $('#spreads-body').html(html);
            } catch (error) {
                handleError(element, "Impossible de charger les spreads");
            } finally {
                setLoading(element, false);
            }
        }

        async function updateMarketConditions() {
            const element = document.getElementById('market-conditions');
            try {
                setLoading(element, true);
                const data = await apiRequest('/api/market_conditions');
                let html = '';
                data.forEach(item => {
                    const volatilityClass = item.volatility >= 70 ? 'bg-danger' : 
                                          item.volatility >= 30 ? 'bg-warning' : 'bg-success';
                    html += `
                        <tr>
                            <td>${item.symbol}</td>
                            <td>
                                <div class="progress">
                                    <div class="progress-bar ${volatilityClass}" 
                                         role="progressbar" 
                                         style="width: ${item.volatility}%"
                                         aria-valuenow="${item.volatility}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                        ${item.volatility}%
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge ${item.trend === 'HAUSSIER' ? 'bg-success' : 'bg-danger'}">
                                    ${item.trend}
                                </span>
                            </td>
                            <td>
                                <span class="${item.volume_trend === 'INCREASING' ? 'text-success' : 'text-danger'}">
                                    <i class="fas fa-arrow-${item.volume_trend === 'INCREASING' ? 'up' : 'down'}"></i>
                                    ${item.volume_trend}
                                </span>
                            </td>
                        </tr>
                    `;
                });
                $('#market-conditions-body').html(html);
            } catch (error) {
                handleError(element, "Impossible de charger les conditions de marché");
            } finally {
                setLoading(element, false);
            }
        }

        async function updatePerformanceCharts() {
            const dailyChart = document.getElementById('daily-performance-chart');
            const distributionChart = document.getElementById('trade-distribution-chart');
            
            try {
                setLoading(dailyChart.parentElement, true);
                setLoading(distributionChart.parentElement, true);
                
                const data = await apiRequest('/api/performance');
                const isDarkMode = document.body.classList.contains('dark-mode');
                
                const chartConfig = {
                    paper_bgcolor: isDarkMode ? '#2d2d2d' : '#fff',
                    plot_bgcolor: isDarkMode ? '#2d2d2d' : '#fff',
                    font: {
                        color: isDarkMode ? '#fff' : '#000'
                    },
                    xaxis: {
                        gridcolor: isDarkMode ? '#404040' : '#e6e6e6'
                    },
                    yaxis: {
                        gridcolor: isDarkMode ? '#404040' : '#e6e6e6'
                    }
                };

                // Daily performance chart
                const dailyTrace = {
                    x: data.dates,
                    y: data.daily_returns,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Performance',
                    line: {
                        color: '#2196F3',
                        width: 2
                    },
                    marker: {
                        size: 6
                    }
                };

                const dailyLayout = {
                    ...chartConfig,
                    title: 'Performance Journalière',
                    xaxis: { 
                        title: 'Date',
                        ...chartConfig.xaxis
                    },
                    yaxis: { 
                        title: 'Rendement (%)',
                        ...chartConfig.yaxis
                    },
                    height: 300,
                    margin: { t: 30, l: 60, r: 30, b: 40 }
                };

                Plotly.newPlot('daily-performance-chart', [dailyTrace], dailyLayout);

                // Distribution chart
                const distributionTrace = {
                    x: data.profit_ranges,
                    y: data.trade_counts,
                    type: 'bar',
                    marker: {
                        color: data.profit_ranges.map(val => val >= 0 ? '#4CAF50' : '#F44336')
                    }
                };

                const distributionLayout = {
                    ...chartConfig,
                    title: 'Distribution des Profits/Pertes',
                    xaxis: { 
                        title: 'Profit/Perte',
                        ...chartConfig.xaxis
                    },
                    yaxis: { 
                        title: 'Nombre de Trades',
                        ...chartConfig.yaxis
                    },
                    height: 300,
                    margin: { t: 30, l: 60, r: 30, b: 40 }
                };

                Plotly.newPlot('trade-distribution-chart', [distributionTrace], distributionLayout);
            } catch (error) {
                handleError(dailyChart.parentElement, "Impossible de charger les graphiques de performance");
                handleError(distributionChart.parentElement, "Impossible de charger les graphiques de performance");
            } finally {
                setLoading(dailyChart.parentElement, false);
                setLoading(distributionChart.parentElement, false);
            }
        }

        async function updateAlerts() {
            const element = document.getElementById('alerts-container');
            try {
                setLoading(element, true);
                const data = await apiRequest('/api/alerts');
                let html = '';
                let count = 0;
                data.forEach(alert => {
                    if (!alert.read) count++;
                    html += `
                        <div class="alert alert-${alert.type} ${alert.read ? 'opacity-75' : ''}" role="alert">
                            <strong>${alert.timestamp}</strong>: ${alert.message}
                        </div>
                    `;
                });
                element.innerHTML = html;
                $('#alerts-count').text(count);
            } catch (error) {
                handleError(element, "Impossible de charger les alertes");
            } finally {
                setLoading(element, false);
            }
        }

        async function updateAccountInfo() {
            const element = document.getElementById('account-info');
            try {
                setLoading(element, true);
                const data = await apiRequest('/api/account');
                element.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Balance</h5>
                            <p class="h3">${data.balance.toFixed(2)}</p>
                        </div>
                        <div class="col-md-6">
                            <h5>Equity</h5>
                            <p class="h3">${data.equity.toFixed(2)}</p>
                        </div>
                        <div class="col-md-6">
                            <h5>Margin</h5>
                            <p>${data.margin.toFixed(2)}</p>
                        </div>
                        <div class="col-md-6">
                            <h5>Free Margin</h5>
                            <p>${data.free_margin.toFixed(2)}</p>
                        </div>
                        <div class="col-md-6">
                            <h5>Margin Level</h5>
                            <p>${data.margin_level?.toFixed(2) || 'N/A'}%</p>
                        </div>
                        <div class="col-md-6">
                            <h5>Profit</h5>
                            <p class="h4 ${data.profit >= 0 ? 'profit' : 'loss'}">
                                ${data.profit.toFixed(2)}
                            </p>
                        </div>
                    </div>
                `;
            } catch (error) {
                handleError(element, "Impossible de charger les informations du compte");
            } finally {
                setLoading(element, false);
            }
        }

        async function updatePositions() {
            const element = document.getElementById('positions-table');
            try {
                setLoading(element, true);
                const data = await apiRequest('/api/positions');
                let html = '';
                data.forEach(position => {
                    html += `
                        <tr>
                            <td>${position.ticket}</td>
                            <td>${position.symbol}</td>
                            <td>
                                <span class="badge ${position.type === 'BUY' ? 'bg-success' : 'bg-danger'}">
                                    ${position.type}
                                </span>
                            </td>
                            <td>${position.volume}</td>
                            <td>${position.open_price.toFixed(5)}</td>
                            <td>${position.current_price.toFixed(5)}</td>
                            <td>${position.sl?.toFixed(5) || '-'}</td>
                            <td>${position.tp?.toFixed(5) || '-'}</td>
                            <td class="${position.profit >= 0 ? 'profit' : 'loss'}">
                                ${position.profit.toFixed(2)}
                            </td>
                            <td>${position.time}</td>
                        </tr>
                    `;
                });
                $('#positions-body').html(html || '<tr><td colspan="10" class="text-center">Aucune position ouverte</td></tr>');
            } catch (error) {
                handleError(element, "Impossible de charger les positions");
            } finally {
                setLoading(element, false);
            }
        }

        async function updateChart() {
            const element = document.getElementById('price-chart');
            try {
                setLoading(element, true);
                const symbol = $('#symbol-select').val();
                const data = await apiRequest(`/api/chart/${symbol}`);
                if (data.chart) {
                    const chartData = JSON.parse(data.chart);
                    const isDarkMode = document.body.classList.contains('dark-mode');
                    
                    // Apply theme to chart
                    const layout = {
                        paper_bgcolor: isDarkMode ? '#2d2d2d' : '#fff',
                        plot_bgcolor: isDarkMode ? '#2d2d2d' : '#fff',
                        font: {
                            color: isDarkMode ? '#fff' : '#000'
                        },
                        xaxis: {
                            gridcolor: isDarkMode ? '#404040' : '#e6e6e6'
                        },
                        yaxis: {
                            gridcolor: isDarkMode ? '#404040' : '#e6e6e6'
                        }
                    };

                    Plotly.newPlot('price-chart', chartData, layout);
                }
            } catch (error) {
                handleError(element, "Impossible de charger le graphique");
            } finally {
                setLoading(element, false);
            }
        }

        async function updateStats() {
            const element = document.getElementById('trading-stats');
            try {
                setLoading(element, true);
                const data = await apiRequest('/api/stats');
                element.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Trades totaux</h5>
                            <p class="h4">${data.total_trades}</p>
                        </div>
                        <div class="col-md-6">
                            <h5>Win Rate</h5>
                            <p class="h4">${data.win_rate.toFixed(2)}%</p>
                        </div>
                        <div class="col-md-6">
                            <h5>Profit total</h5>
                            <p class="h4 ${data.total_profit >= 0 ? 'profit' : 'loss'}">
                                ${data.total_profit.toFixed(2)}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h5>Facteur de profit</h5>
                            <p class="h4">${data.profit_factor.toFixed(2)}</p>
                        </div>
                        <div class="col-md-6">
                            <h5>Plus grand gain</h5>
                            <p class="profit">${data.largest_win.toFixed(2)}</p>
                        </div>
                        <div class="col-md-6">
                            <h5>Plus grande perte</h5>
                            <p class="loss">${data.largest_loss.toFixed(2)}</p>
                        </div>
                        <div class="col-md-6">
                            <h5>Gain moyen</h5>
                            <p class="profit">${data.average_win.toFixed(2)}</p>
                        </div>
                        <div class="col-md-6">
                            <h5>Perte moyenne</h5>
                            <p class="loss">${data.average_loss.toFixed(2)}</p>
                        </div>
                    </div>
                `;
            } catch (error) {
                handleError(element, "Impossible de charger les statistiques");
            } finally {
                setLoading(element, false);
            }
        }

        async function updateHistory() {
            const element = document.getElementById('history-body');
            try {
                setLoading(element, true);
                const data = await apiRequest('/api/history');
                let html = '';
                data.forEach(trade => {
                    html += `
                        <tr>
                            <td>${trade.close_time}</td>
                            <td>${trade.symbol}</td>
                            <td>
                                <span class="badge ${trade.type === 'BUY' ? 'bg-success' : 'bg-danger'}">
                                    ${trade.type}
                                </span>
                            </td>
                            <td>${trade.volume}</td>
                            <td>${trade.open_price.toFixed(5)}</td>
                            <td>${trade.close_price.toFixed(5)}</td>
                            <td class="${trade.profit >= 0 ? 'profit' : 'loss'}">
                                ${trade.profit.toFixed(2)}
                            </td>
                        </tr>
                    `;
                });
                $('#history-body').html(html || '<tr><td colspan="7" class="text-center">Aucun historique disponible</td></tr>');
            } catch (error) {
                handleError(element, "Impossible de charger l'historique");
            } finally {
                setLoading(element, false);
            }
        }
    </script>
</body>
</html>
